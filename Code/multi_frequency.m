%%%%%多频分级相位展开方法  phase retrieval
clc; close all; clear;
m=4;  %频率数
n=6;  %相移数
HIGHrLOW = [2,4,4];%m-1频率之比1 2 8 32
Img_total=cell(m,n);
N=5; %共有11个位置
% id_noise=[2,6,20];
% id_normal=[1,3,4,5,7,8,9,10,11,12,13,14,15,16,17,18,19,21];
id_normal=22:26;  %复杂曲面图像
%%%数据读取
for k = 1:N
    for i=1:m
        for j=1:n
            path=['..\Data\', num2str(id_normal(k)), '_', num2str(i), '_', num2str(j),'.bmp'];
            Img_total{i,j}=imread(path);
            Img_total{i,j}=im2double(Img_total{i,j});
        end
    end
    %%%提取包裹相位
    for i=1:m
        numerator=0;
        denominator=0;
        for j=1:n
            numerator=numerator+Img_total{i,j}*sin(2*(j-1)*pi/n);
            denominator=denominator+Img_total{i,j}*cos(2*(j-1)*pi/n);
        end
        phi(:,:,i)=-atan2(numerator,denominator)+pi;
    end
    %%%相位展开
    phl = phi(:,:,1);
    for i=1:m-1
        phh = phi(:,:,i+1);
        kh = round((HIGHrLOW(i)*phl-phh)/(2*pi));
        khlist(:,:,i) = kh;
        phl = phh + kh*2*pi;
        phllist(:,:,i) = phl;
    end
    phi_unwrapped = phl; 
    path=['..\Images\Phase\',num2str(id_normal(k)),'.mat'];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
%     figure(1);plot(phi_unwrapped(350,:)/pi);xlabel('像素u/pixel');ylabel('相位/rad'); 
%     figure(2);plot(phi_unwrapped(350,:));xlabel('像素u/pixel');ylabel('相位/rad'); 
%     figure(3);plot(kh(350,:));xlabel('像素u/pixel');ylabel('相位级次'); 
%     figure(4);imshow(phi_unwrapped,[]);title('相位图');
%     save(path, 'phi_unwrapped');
end
